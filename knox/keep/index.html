<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ignite OS - Workspace</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #202124;
            --sidebar: #252628;
            --surface: #2d2e30;
            --hover: #3c4043;
            --text: #e8eaed;
            --text-mute: #9aa0a6;
            --accent: #fbbc04;
            --blue: #8ab4f8;
            --red: #f28b82;
            --border: #5f6368;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 10px; flex-shrink: 0; }
        .brand { font-size: 20px; font-weight: bold; margin-bottom: 30px; padding-left: 15px; display: flex; align-items: center; gap: 10px; }
        .brand i { color: var(--accent); }
        
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 12px 20px; color: var(--text-mute); border-radius: 0 25px 25px 0; cursor: pointer; transition: 0.2s; font-weight: 500; font-size: 14px; }
        .nav-item:hover { background: var(--hover); color: var(--text); }
        .nav-item.active { background: rgba(251, 188, 4, 0.2); color: var(--accent); }
        .nav-item i { width: 20px; text-align: center; }

        .tools-section { margin-top: auto; border-top: 1px solid var(--border); padding-top: 15px; }
        .tool-header { font-size: 11px; text-transform: uppercase; color: var(--text-mute); padding-left: 20px; margin-bottom: 10px; font-weight: bold; }

        /* --- MAIN AREA --- */
        .main { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        
        /* Top Bar */
        .top-bar { padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .search-box { background: var(--surface); border-radius: 8px; padding: 8px 15px; width: 400px; display: flex; align-items: center; gap: 10px; color: var(--text-mute); transition: 0.2s; }
        .search-box:focus-within { background: #fff; color: #000; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .search-input { background: transparent; border: none; outline: none; color: inherit; width: 100%; font-size: 15px; }
        
        /* Content Area */
        .content-area { flex-grow: 1; overflow-y: auto; padding: 30px; }
        
        /* Create Bar (Only in My Notes) */
        .create-bar { display: flex; justify-content: center; margin-bottom: 30px; }
        .create-box { background: var(--surface); width: 600px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid var(--border); padding: 10px; position: relative; }
        .create-input { background: transparent; border: none; width: 100%; color: #fff; outline: none; display: none; margin-bottom: 10px; font-weight: bold; font-size: 16px; }
        .create-textarea { background: transparent; border: none; width: 100%; color: var(--text-mute); outline: none; resize: none; font-family: inherit; font-size: 14px; }
        .create-btns { display: none; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; }
        .card { 
            background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 15px; 
            display: flex; flex-direction: column; height: 160px; position: relative; transition: 0.2s; cursor: pointer;
        }
        .card:hover { border-color: var(--text-mute); box-shadow: 0 4px 8px rgba(0,0,0,0.3); transform: translateY(-2px); }
        .card-title { font-weight: bold; margin-bottom: 8px; font-size: 15px; }
        .card-body { font-size: 13px; color: var(--text-mute); flex-grow: 1; overflow: hidden; white-space: pre-wrap; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; }
        
        .card-actions { 
            display: flex; justify-content: flex-end; gap: 5px; margin-top: 10px; opacity: 0; transition: 0.2s;
        }
        .card:hover .card-actions { opacity: 1; }
        .btn-icon { background: transparent; border: none; color: var(--text-mute); width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-icon.del:hover { color: var(--red); background: rgba(242, 139, 130, 0.1); }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: var(--bg); width: 80%; height: 85%; border-radius: 10px; border: 1px solid var(--border); display: flex; flex-direction: column; position: relative; }
        
        /* Editor */
        .editor-top { border-bottom: 1px solid var(--border); padding: 15px; display: flex; justify-content: space-between; align-items: center; background: var(--surface); border-radius: 10px 10px 0 0; }
        .ribbon { display: flex; flex-direction: row-reverse; }
        .face { width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--surface); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 10px; font-weight: bold; margin-left: -8px; }
        
        .editor-main { flex-grow: 1; padding: 40px; display: flex; flex-direction: column; background: var(--bg); }
        .editor-h1 { background: transparent; border: none; font-size: 28px; font-weight: bold; color: #fff; margin-bottom: 20px; outline: none; }
        .editor-p { background: transparent; border: none; font-size: 16px; line-height: 1.6; color: var(--text); outline: none; resize: none; flex-grow: 1; font-family: inherit; }

        /* Tools Modal */
        .tool-frame { width: 100%; height: 100%; border: none; background: #fff; }
        .tool-title { font-weight: bold; color: var(--accent); }

        .hidden { display: none !important; }
        .restore-btn { color: var(--blue); }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="brand"><i class="fa-solid fa-layer-group"></i> Ignite OS</div>
        
        <div class="nav-item active" onclick="switchView('notes')" id="nav-notes">
            <i class="fa-regular fa-lightbulb"></i> My Notes
        </div>
        <div class="nav-item" onclick="switchView('shared')" id="nav-shared">
            <i class="fa-solid fa-user-group"></i> Shared with Me
        </div>
        <div class="nav-item" onclick="switchView('trash')" id="nav-trash">
            <i class="fa-regular fa-trash-can"></i> Trash
        </div>

        <div class="tools-section">
            <div class="tool-header">Quick Tools</div>
            <div class="nav-item" onclick="openTool('Wikipedia')">
                <i class="fa-brands fa-wikipedia-w"></i> Wikipedia
            </div>
            <div class="nav-item" onclick="openTool('Translator')">
                <i class="fa-solid fa-language"></i> Translator
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">
        <div class="top-bar">
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" class="search-input" id="searchInp" placeholder="Search..." onkeyup="filterNotes()">
            </div>
            <div style="display:flex; gap:15px; align-items:center;">
                <span id="userId" style="font-size:12px; color:gray;"></span>
                <button onclick="logout()" style="background:none; border:1px solid #555; color:#fff; padding:5px 15px; cursor:pointer; border-radius:4px;">Log Out</button>
            </div>
        </div>

        <div class="content-area">
            <!-- Create Box (Only visible in 'notes' view) -->
            <div class="create-bar" id="createBar">
                <div class="create-box" id="createBox">
                    <input type="text" class="create-input" id="newTitle" placeholder="Title">
                    <textarea class="create-textarea" id="newContent" rows="1" placeholder="Take a note..."></textarea>
                    <div class="create-btns" id="createBtns">
                        <button class="btn-icon" onclick="resetCreate()"><i class="fa-solid fa-xmark"></i></button>
                        <button style="background:var(--accent); border:none; padding:6px 15px; border-radius:4px; font-weight:bold; cursor:pointer;" onclick="createNote()">Save</button>
                    </div>
                </div>
            </div>

            <h2 id="viewTitle" style="margin-bottom:20px; font-size:18px; color:var(--text-mute);">My Notes</h2>
            <div class="grid" id="grid"></div>
        </div>
    </div>

    <!-- EDITOR MODAL -->
    <div class="modal" id="editorModal">
        <div class="modal-box">
            <div class="editor-top">
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn-icon" onclick="closeEditor()"><i class="fa-solid fa-arrow-left"></i></button>
                    <span id="saveStatus" style="font-size:12px; color:gray;">Saved</span>
                </div>
                <div style="display:flex; gap:15px; align-items:center;">
                    <div class="ribbon" id="collabRibbon"></div>
                    <button class="btn-icon" title="Share" onclick="toggleShareUI()"><i class="fa-solid fa-user-plus"></i></button>
                    <!-- Tools inside Editor -->
                    <button class="btn-icon" title="Wiki" onclick="openTool('Wikipedia')"><i class="fa-brands fa-wikipedia-w"></i></button>
                </div>
            </div>
            
            <!-- Share Dropdown (Absolute) -->
            <div id="shareUI" style="display:none; position:absolute; top:60px; right:20px; background:#333; padding:15px; border:1px solid #555; border-radius:8px; width:250px;">
                <input id="shareEmail" placeholder="ID (user@ignite.com)" style="width:100%; padding:8px; margin-bottom:8px; background:#222; border:none; color:#fff;">
                <button onclick="shareNote()" style="width:100%; background:var(--accent); border:none; padding:5px; font-weight:bold; cursor:pointer;">Add</button>
            </div>

            <div class="editor-main">
                <input id="editTitle" class="editor-h1" placeholder="Title">
                <textarea id="editContent" class="editor-p" placeholder="Start typing..."></textarea>
            </div>
        </div>
    </div>

    <!-- TOOL MODAL -->
    <div class="modal" id="toolModal">
        <div class="modal-box" style="background:#fff; width:70%; height:80%;">
            <div style="padding:10px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between; align-items:center; background:#f1f3f4;">
                <span class="tool-title" id="toolName">Tool</span>
                <button onclick="document.getElementById('toolModal').style.display='none'" style="border:none; background:none; font-size:18px; cursor:pointer;">âœ•</button>
            </div>
            <iframe id="toolFrame" class="tool-frame" src=""></iframe>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw", authDomain: "xperts-metadata.firebaseapp.com", projectId: "xperts-metadata", storageBucket: "xperts-metadata.firebasestorage.app", messagingSenderId: "514845910910", appId: "1:514845910910:web:5a2402130a97b5d749b52f", measurementId: "G-CQ5KWGJSZB" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- STATE ---
        let user = null;
        let notesData = []; // Store locally for sorting/searching
        let currentView = 'notes'; // notes, shared, trash
        let myColor = '#' + Math.floor(Math.random()*16777215).toString(16);

        // --- INIT ---
        function init() {
            const s = localStorage.getItem('xperts_multi_session');
            if(!s) { window.location.href="index.html"; return; }
            user = JSON.parse(s)[0];
            document.getElementById('userId').innerText = user.igniteId || user.name;
            setupListeners();
        }

        function logout() { localStorage.removeItem('xperts_multi_session'); window.location.href="index.html"; }

        // --- VIEW SWITCHING ---
        function switchView(view) {
            currentView = view;
            
            // UI Updates
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${view}`).classList.add('active');
            
            const titles = { notes: 'My Notes', shared: 'Shared with Me', trash: 'Trash' };
            document.getElementById('viewTitle').innerText = titles[view];
            
            // Hide/Show Create Bar
            document.getElementById('createBar').style.display = (view === 'notes') ? 'flex' : 'none';

            // Refresh Data
            setupListeners();
        }

        // --- DATA FETCHING & SORTING (FIXED SORTING) ---
        let unsubscribe = null;

        function setupListeners() {
            if(unsubscribe) unsubscribe(); // Kill old listener
            const grid = document.getElementById('grid');
            grid.innerHTML = '<div style="color:gray">Loading...</div>';
            notesData = [];

            let q;
            
            if(currentView === 'notes') {
                // My notes, not in trash
                q = db.collection('notes')
                    .where('ownerId', '==', user.uid)
                    .where('isTrashed', '==', false);
            } else if (currentView === 'shared') {
                // Shared, not trash
                if(!user.igniteId) { grid.innerHTML = "No Ignite ID"; return; }
                q = db.collection('notes')
                    .where('sharedWith', 'array-contains', user.igniteId)
                    .where('isTrashed', '==', false); // Assuming shared docs respect owner trash state
            } else if (currentView === 'trash') {
                // My notes, IN trash
                q = db.collection('notes')
                    .where('ownerId', '==', user.uid)
                    .where('isTrashed', '==', true);
            }

            unsubscribe = q.onSnapshot(snap => {
                // We map all docs to an array, then SORT client-side for "Newest First"
                // This avoids needing complex Composite Indexes in Firestore console for every user
                const tempNotes = [];
                snap.forEach(doc => {
                    tempNotes.push({ id: doc.id, ...doc.data() });
                });

                // SORTING LOGIC: Newest timestamp first
                tempNotes.sort((a, b) => {
                    const tA = a.createdAt ? a.createdAt.seconds : 0;
                    const tB = b.createdAt ? b.createdAt.seconds : 0;
                    return tB - tA; // Descending
                });

                notesData = tempNotes;
                renderGrid();
            });
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            const term = document.getElementById('searchInp').value.toLowerCase();
            const filtered = notesData.filter(n => (n.title||'').toLowerCase().includes(term) || (n.content||'').toLowerCase().includes(term));

            if(filtered.length === 0) {
                grid.innerHTML = '<div style="margin:20px; color:gray">No notes found.</div>';
                return;
            }

            filtered.forEach(note => {
                const el = document.createElement('div');
                el.className = 'card';
                el.onclick = (e) => {
                    if(!e.target.closest('button')) {
                        if(currentView === 'trash') alert("Restore note to edit.");
                        else openEditor(note.id);
                    }
                };

                let buttons = '';
                if(currentView === 'trash') {
                    // Trash View Buttons
                    buttons = `
                        <button class="btn-icon restore-btn" onclick="restoreNote('${note.id}')" title="Restore"><i class="fa-solid fa-trash-arrow-up"></i></button>
                        <button class="btn-icon del" onclick="deleteForever('${note.id}')" title="Delete Forever"><i class="fa-solid fa-ban"></i></button>
                    `;
                } else {
                    // Standard View Buttons
                    const isOwner = note.ownerId === user.uid;
                    buttons = `
                         <button class="btn-icon" onclick="copyNote('${note.id}', '${note.title}')" title="Clone"><i class="fa-regular fa-clone"></i></button>
                         ${isOwner ? `<button class="btn-icon del" onclick="moveToTrash('${note.id}')" title="Move to Trash"><i class="fa-solid fa-trash"></i></button>` : ''}
                    `;
                }

                el.innerHTML = `
                    <div class="card-title">${note.title || '(Untitled)'}</div>
                    <div class="card-body">${note.content || ''}</div>
                    <div class="card-actions">${buttons}</div>
                `;
                grid.appendChild(el);
            });
        }

        function filterNotes() { renderGrid(); }

        // --- TRASH LOGIC ---
        async function moveToTrash(id) {
            if(confirm("Move to Trash?")) {
                await db.collection('notes').doc(id).update({ isTrashed: true });
            }
        }
        async function restoreNote(id) {
            await db.collection('notes').doc(id).update({ isTrashed: false });
        }
        async function deleteForever(id) {
            if(confirm("Permanently delete? This cannot be undone.")) {
                await db.collection('notes').doc(id).delete();
            }
        }

        // --- CREATE NOTE ---
        const cBox = document.getElementById('createBox');
        const cTitle = document.getElementById('newTitle');
        const cContent = document.getElementById('newContent');
        const cBtns = document.getElementById('createBtns');

        cContent.addEventListener('focus', () => {
            cTitle.style.display = 'block';
            cBtns.style.display = 'flex';
            cContent.rows = 4;
        });

        function resetCreate() {
            cTitle.style.display = 'none';
            cBtns.style.display = 'none';
            cContent.rows = 1;
            cTitle.value = ''; cContent.value = '';
        }

        async function createNote() {
            const t = cTitle.value;
            const c = cContent.value;
            if(!t && !c) return;
            
            await db.collection('notes').add({
                title: t, content: c,
                ownerId: user.uid,
                isTrashed: false,
                sharedWith: [],
                viewers: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            resetCreate();
        }

        // --- EDITOR & REALTIME ---
        let curId = null;
        let editUnsub = null;
        const eTitle = document.getElementById('editTitle');
        const eContent = document.getElementById('editContent');

        async function openEditor(id) {
            curId = id;
            document.getElementById('editorModal').style.display = 'flex';
            
            // Add Presence
            db.collection('notes').doc(id).update({
                viewers: firebase.firestore.FieldValue.arrayUnion({ name: user.name, color: myColor, id: user.uid })
            });

            editUnsub = db.collection('notes').doc(id).onSnapshot(doc => {
                if(!doc.exists) { closeEditor(); return; }
                const d = doc.data();
                
                // Sync text if not focused
                if(document.activeElement !== eTitle) eTitle.value = d.title;
                if(document.activeElement !== eContent) eContent.value = d.content;

                // Sync Ribbon
                const rib = document.getElementById('collabRibbon');
                rib.innerHTML = '';
                (d.viewers||[]).forEach(v => {
                    const d = document.createElement('div');
                    d.className = 'face';
                    d.style.backgroundColor = v.color;
                    d.innerText = v.name.charAt(0);
                    d.title = v.name;
                    rib.appendChild(d);
                });
            });
        }

        // Auto Save (Input Handler)
        const handleInput = () => {
             document.getElementById('saveStatus').innerText = 'Saving...';
             setTimeout(() => {
                 if(curId) {
                     db.collection('notes').doc(curId).update({
                         title: eTitle.value, content: eContent.value
                     }).then(() => document.getElementById('saveStatus').innerText = 'Saved');
                 }
             }, 500);
        };
        eTitle.addEventListener('input', handleInput);
        eContent.addEventListener('input', handleInput);

        async function closeEditor() {
            if(curId) {
                // Remove Presence
                const ref = db.collection('notes').doc(curId);
                const snap = await ref.get();
                if(snap.exists) {
                    const viewers = snap.data().viewers || [];
                    const updated = viewers.filter(v => v.id !== user.uid);
                    await ref.update({ viewers: updated });
                }
            }
            document.getElementById('editorModal').style.display = 'none';
            if(editUnsub) editUnsub();
            curId = null;
        }

        // --- TOOLS & SHARING ---
        function openTool(name) {
            const map = {
                'Wikipedia': 'https://en.m.wikipedia.org/wiki/Special:Search',
                'Translator': 'https://www.bing.com/translator' // Google translate often blocks framing, Bing is friendlier or use generic
            };
            document.getElementById('toolName').innerText = name;
            document.getElementById('toolFrame').src = map[name];
            document.getElementById('toolModal').style.display = 'flex';
        }

        function toggleShareUI() {
            const ui = document.getElementById('shareUI');
            ui.style.display = ui.style.display === 'none' ? 'block' : 'none';
        }

        async function shareNote() {
            const email = document.getElementById('shareEmail').value;
            if(curId && email.includes('@ignite.com')) {
                await db.collection('notes').doc(curId).update({
                    sharedWith: firebase.firestore.FieldValue.arrayUnion(email)
                });
                alert('Shared');
                toggleShareUI();
            } else { alert('Invalid ID'); }
        }
        
        async function copyNote(id, title) {
            const old = notesData.find(n => n.id === id);
            if(old) {
                await db.collection('notes').add({
                    title: "Copy - " + old.title, content: old.content,
                    ownerId: user.uid, isTrashed: false, sharedWith: [], createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        init();
    </script>
</body>
</html>