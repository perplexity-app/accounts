<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ignite Mobile Pro</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #F2F4F8;
            --bg-card: #FFFFFF;
            --primary: #0B57D0;
            --primary-light: #D3E3FD;
            --text-main: #1F1F1F;
            --text-sec: #555;
            --border: #E0E2E0;
            --radius: 16px;
            --floating-bg: #2d2e30; /* Dark menu like iOS */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- 1. HEADER & SEARCH --- */
        .header {
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            gap: 10px;
            z-index: 10;
        }

        .menu-btn { font-size: 20px; padding: 8px; background: none; border: none; cursor: pointer; color: var(--text-sec); }
        
        .search-box {
            flex: 1;
            background: #EFF1F5;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 15px;
        }
        .search-box input { background: transparent; border: none; outline: none; flex: 1; margin-left: 8px; font-family: inherit; font-size: 15px; }

        .profile-pic { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- 2. NOTES GRID --- */
        .content-area { flex: 1; overflow-y: auto; padding: 15px; position: relative; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr; /* Single column for small screens */
            gap: 12px;
            padding-bottom: 80px; /* Space for FAB */
        }
        
        /* 2 Columns on slightly larger phones */
        @media (min-width: 400px) { .grid { grid-template-columns: 1fr 1fr; } }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            min-height: 120px;
            border: 1px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
            transition: 0.2s;
        }
        .card:active { transform: scale(0.98); background: #fafafa; }
        .card-title { font-weight: 700; font-size: 16px; margin-bottom: 6px; }
        .card-body { font-size: 14px; color: var(--text-sec); line-height: 1.4; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical; }

        /* Floating Add Button (FAB) */
        .fab {
            position: absolute; bottom: 20px; right: 20px;
            width: 56px; height: 56px;
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: var(--primary);
            cursor: pointer;
            z-index: 20;
            border: 1px solid var(--primary-light);
        }

        /* --- 3. EDITOR (Full Screen) --- */
        .editor {
            position: fixed; inset: 0; background: #fff; z-index: 100;
            display: none; flex-direction: column;
        }
        .editor.open { display: flex; animation: slideUp 0.25s cubic-bezier(0.2, 0, 0, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .editor-nav { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
        .status-badge { font-size: 12px; font-weight: 600; color: #137333; opacity: 0; transition: 0.3s; background: #E6F4EA; padding: 4px 10px; border-radius: 10px; }
        
        .editor-content { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; position: relative; }
        
        .inp-title { font-size: 24px; font-weight: 800; border: none; outline: none; margin-bottom: 15px; font-family: inherit; width: 100%; }
        .inp-body { font-size: 17px; line-height: 1.6; border: none; outline: none; flex: 1; resize: none; font-family: inherit; color: #333; -webkit-overflow-scrolling: touch; }

        /* --- 4. FLOATING CONTEXT MENU (The Magic Part) --- */
        .floating-menu {
            position: absolute;
            background: var(--floating-bg);
            border-radius: 30px;
            padding: 0 10px;
            height: 44px;
            display: none; /* Flex when active */
            align-items: center;
            gap: 5px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 200;
            transform: translateX(-50%);
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap;
        }
        @keyframes popIn { from { transform: translateX(-50%) scale(0.8); opacity: 0; } to { transform: translateX(-50%) scale(1); opacity: 1; } }
        
        /* Triangle Pointer */
        .floating-menu::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            border-width: 6px 6px 0; border-style: solid; border-color: var(--floating-bg) transparent transparent transparent;
        }

        .float-btn {
            background: transparent; border: none; color: white;
            font-size: 13px; font-weight: 500; padding: 0 10px;
            height: 100%; cursor: pointer; display: flex; align-items: center; gap: 6px;
        }
        .float-btn:active { opacity: 0.7; }
        .divider { width: 1px; height: 16px; background: rgba(255,255,255,0.3); }

        /* --- 5. BOTTOM SHEET (Results) --- */
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #fff;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
            z-index: 300;
            transform: translateY(110%);
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
            max-height: 60vh;
            display: flex; flex-direction: column;
        }
        .bottom-sheet.open { transform: translateY(0); }
        
        .sheet-handle { width: 40px; height: 5px; background: #ddd; border-radius: 5px; margin: 12px auto; }
        .sheet-content { padding: 0 25px 30px 25px; overflow-y: auto; }
        .sheet-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; color: var(--primary); display: flex; align-items: center; gap: 10px; }

        /* --- 6. SIDEBAR --- */
        .sidebar {
            position: fixed; inset: 0; z-index: 500; pointer-events: none;
        }
        .sidebar-bg { position: absolute; inset: 0; background: rgba(0,0,0,0.6); opacity: 0; transition: 0.3s; }
        .sidebar-panel {
            position: absolute; top: 0; bottom: 0; left: 0;
            width: 85vw; max-width: 300px;
            background: #fff;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
            padding: 20px; display: flex; flex-direction: column;
            pointer-events: auto;
        }
        .sidebar.active { pointer-events: auto; }
        .sidebar.active .sidebar-bg { opacity: 1; }
        .sidebar.active .sidebar-panel { transform: translateX(0); }

        .nav-link { padding: 15px; font-size: 16px; font-weight: 500; color: #333; border-radius: 12px; margin-bottom: 5px; display: flex; align-items: center; gap: 15px; }
        .nav-link.active { background: var(--primary-light); color: var(--primary); font-weight: 700; }

        .hidden { display: none !important; }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-bg" onclick="toggleSidebar()"></div>
        <div class="sidebar-panel">
            <h2 style="margin: 0 0 30px 10px; display:flex; gap:10px; align-items:center;">
                <i class="fa-solid fa-fire" style="color:var(--primary)"></i> Ignite
            </h2>
            <div class="nav-link active"><i class="fa-regular fa-file"></i> Notes</div>
            <div class="nav-link"><i class="fa-solid fa-users"></i> Shared</div>
            <div class="nav-link"><i class="fa-regular fa-star"></i> Favorites</div>
            <div class="nav-link"><i class="fa-solid fa-gear"></i> Settings</div>
            
            <div style="margin-top:auto; border-top:1px solid #eee; padding-top:20px;">
                <div style="font-weight:bold;" id="sideName">User</div>
                <div style="font-size:13px; color:#888;" id="sideEmail">@ignite.com</div>
                <button onclick="logout()" style="margin-top:15px; width:100%; padding:12px; border:1px solid #ddd; background:none; border-radius:10px; font-weight:bold;">Log Out</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="header">
        <button class="menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        <div class="search-box">
            <i class="fa-solid fa-search" style="color:#888"></i>
            <input type="text" placeholder="Search notes..." id="searchInp" onkeyup="filterNotes()">
        </div>
        <div class="profile-pic" id="headerAvatar">U</div>
    </div>

    <div class="content-area">
        <div class="grid" id="notesGrid">
            <!-- Notes here -->
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="fab" onclick="createNote()"><i class="fa-solid fa-plus"></i></div>

    <!-- FULL SCREEN EDITOR -->
    <div class="editor" id="editor">
        <div class="editor-nav">
            <button onclick="closeEditor()" style="border:none; background:none; font-size:22px; color:#444;"><i class="fa-solid fa-chevron-left"></i></button>
            <div class="status-badge" id="saveStatus">Saved</div>
            <button onclick="deleteNote()" style="border:none; background:none; font-size:18px; color:#d93025;"><i class="fa-regular fa-trash-can"></i></button>
        </div>
        <div class="editor-content" id="editorContainer">
            <input type="text" class="inp-title" id="eTitle" placeholder="Title">
            <textarea class="inp-body" id="eContent" placeholder="Start typing... Select text for AI tools."></textarea>
            
            <!-- FLOATING CONTEXT MENU -->
            <div class="floating-menu" id="floatMenu">
                <button class="float-btn" onclick="aiAction('wiki')"><i class="fa-brands fa-wikipedia-w"></i> Wiki</button>
                <div class="divider"></div>
                <button class="float-btn" onclick="aiAction('translate')"><i class="fa-solid fa-language"></i> Trans</button>
                <div class="divider"></div>
                <button class="float-btn" onclick="aiAction('speak')"><i class="fa-solid fa-volume-high"></i></button>
            </div>
        </div>
    </div>

    <!-- BOTTOM SHEET (Results) -->
    <div class="bottom-sheet" id="resultSheet">
        <div class="sheet-handle" onclick="closeSheet()"></div>
        <div class="sheet-content">
            <div class="sheet-title" id="sheetTitle">Result</div>
            <div id="sheetBody" style="font-size:15px; line-height:1.6; color:#333;"></div>
            <button onclick="closeSheet()" style="width:100%; padding:15px; background:#f0f0f0; border:none; border-radius:12px; margin-top:20px; font-weight:bold; color:#333;">Close</button>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
            authDomain: "xperts-metadata.firebaseapp.com",
            projectId: "xperts-metadata",
            storageBucket: "xperts-metadata.firebasestorage.app",
            messagingSenderId: "514845910910",
            appId: "1:514845910910:web:5a2402130a97b5d749b52f",
            measurementId: "G-CQ5KWGJSZB"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. LOGIC ---
        let user = null;
        let currentNoteId = null;
        let unsub = null;

        function init() {
            const sess = localStorage.getItem('xperts_multi_session');
            if(!sess) { window.location.href="index.html"; return; }
            user = JSON.parse(sess)[0];
            
            document.getElementById('headerAvatar').innerText = user.name.charAt(0);
            document.getElementById('sideName').innerText = user.name;
            document.getElementById('sideEmail').innerText = user.igniteId || user.email;
            
            loadNotes();
        }
        function logout() { localStorage.removeItem('xperts_multi_session'); window.location.href="index.html"; }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

        // --- NOTES CRUD ---
        async function createNote() {
            const doc = await db.collection('notes').add({
                title:"", content:"", ownerId:user.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            openEditor(doc.id);
        }

        function loadNotes() {
            db.collection('notes').where('ownerId','==',user.uid).orderBy('createdAt','desc')
            .onSnapshot(snap => {
                const grid = document.getElementById('notesGrid');
                grid.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const el = document.createElement('div');
                    el.className = 'card';
                    el.onclick = () => openEditor(doc.id);
                    el.innerHTML = `<div class="card-title">${d.title||'Untitled'}</div><div class="card-body">${d.content||'No content'}</div>`;
                    grid.appendChild(el);
                });
            });
        }

        function filterNotes() {
            const term = document.getElementById('searchInp').value.toLowerCase();
            document.querySelectorAll('.card').forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
            });
        }

        // --- EDITOR & AUTO SAVE ---
        function openEditor(id) {
            currentNoteId = id;
            document.getElementById('editor').classList.add('open');
            unsub = db.collection('notes').doc(id).onSnapshot(doc => {
                if(!doc.exists) { closeEditor(); return; }
                const d = doc.data();
                if(document.activeElement.id !== 'eTitle') document.getElementById('eTitle').value = d.title;
                if(document.activeElement.id !== 'eContent') document.getElementById('eContent').value = d.content;
            });
        }

        function closeEditor() {
            document.getElementById('editor').classList.remove('open');
            if(unsub) unsub();
            currentNoteId = null;
            document.getElementById('floatMenu').style.display = 'none';
        }

        let saveTimer;
        const autoSave = () => {
            document.getElementById('saveStatus').style.opacity = 1;
            document.getElementById('saveStatus').innerText = "Saving...";
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                db.collection('notes').doc(currentNoteId).update({
                    title: document.getElementById('eTitle').value,
                    content: document.getElementById('eContent').value
                }).then(() => {
                    document.getElementById('saveStatus').innerText = "Saved";
                    setTimeout(() => document.getElementById('saveStatus').style.opacity = 0, 2000);
                });
            }, 500);
        }
        document.getElementById('eTitle').addEventListener('input', autoSave);
        document.getElementById('eContent').addEventListener('input', autoSave);

        async function deleteNote() {
            if(confirm("Delete?")) { await db.collection('notes').doc(currentNoteId).delete(); closeEditor(); }
        }


        // --- THE FLOATING MENU LOGIC (CORE FEATURE) ---
        const textArea = document.getElementById('eContent');
        const floatMenu = document.getElementById('floatMenu');

        // Handle Selection
        document.addEventListener('selectionchange', () => {
            const selection = window.getSelection();
            
            // Only show if selection is inside our editor text area and not empty
            if (selection.toString().trim().length > 0 && document.activeElement === textArea) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                // Position Menu above text (math handles scroll)
                // rect.top is relative to viewport. 
                // We show it 50px above selection center
                floatMenu.style.top = (rect.top - 55) + 'px';
                floatMenu.style.left = (rect.left + (rect.width / 2)) + 'px';
                floatMenu.style.display = 'flex';
            } else {
                floatMenu.style.display = 'none';
            }
        });

        // Prevents menu from sticking when scrolling
        textArea.addEventListener('scroll', () => { floatMenu.style.display = 'none'; });

        // --- AI TOOLS ACTIONS ---
        function closeSheet() { document.getElementById('resultSheet').classList.remove('open'); }

        async function aiAction(type) {
            const text = window.getSelection().toString().trim();
            if(!text) return;
            
            const sheet = document.getElementById('resultSheet');
            const title = document.getElementById('sheetTitle');
            const body = document.getElementById('sheetBody');

            if(type === 'speak') {
                const u = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(u);
                return; // No sheet needed
            }

            sheet.classList.add('open');
            body.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Loading...';

            if(type === 'wiki') {
                title.innerHTML = '<i class="fa-brands fa-wikipedia-w"></i> Wikipedia';
                try {
                    const req = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(text)}`);
                    const data = await req.json();
                    if(data.type === 'standard') {
                        body.innerHTML = `
                            ${data.thumbnail ? `<img src="${data.thumbnail.source}" style="width:100%; height:150px; object-fit:cover; border-radius:12px; margin-bottom:10px;">` : ''}
                            <b>${data.title}</b><br>${data.extract}
                        `;
                    } else { body.innerText = "No specific page found."; }
                } catch(e) { body.innerText = "Error fetching Wiki."; }
            }
            
            if(type === 'translate') {
                title.innerHTML = '<i class="fa-solid fa-language"></i> Translation';
                try {
                    // Detect lang? For now simplified En->Es/Fr
                    const req = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|es`);
                    const data = await req.json();
                    body.innerHTML = `
                        <div style="font-size:12px; color:#888;">Spanish:</div>
                        <div style="font-size:20px; font-weight:bold;">${data.responseData.translatedText}</div>
                    `;
                } catch(e) { body.innerText = "Translation Error."; }
            }
        }

        init();
    </script>
</body>
</html>