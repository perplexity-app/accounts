<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compose - Email App</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #fff; margin: 0; }
        .header { background: #f6f8fc; padding: 10px 20px; border-bottom: 1px solid #ddd; display: flex; align-items: center; }
        .back-btn { cursor: pointer; display: flex; align-items: center; color: #5f6368; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; }
        input, textarea { width: 100%; padding: 10px; border: none; border-bottom: 1px solid #ddd; outline: none; box-sizing: border-box; }
        textarea { height: 300px; resize: none; margin-top: 10px; }
        .send-btn { background: #1a73e8; color: white; border: none; padding: 10px 25px; border-radius: 4px; cursor: pointer; margin-top: 20px; }
        .send-btn:disabled { background: #ccc; }
        .status { margin-left: 10px; color: #666; font-size: 14px; }
    </style>
</head>
<body>

<div class="header">
    <div class="back-btn" onclick="window.location.href='2.html'"><span class="material-icons">arrow_back</span> Back</div>
</div>

<div class="container">
    <h3>New Message</h3>
    <form id="email-form" onsubmit="sendEmail(event)">
        <input type="email" id="to_email" placeholder="To" required>
        <input type="text" id="subject" placeholder="Subject" required>
        <textarea id="message" placeholder="Message" required></textarea>
        <button type="submit" id="btn-submit" class="send-btn">Send</button>
        <span id="status-msg" class="status"></span>
    </form>
</div>

<script>
    // Initialize EmailJS with your Public Key
    (function(){ emailjs.init("Yr9MutUoHOEONnFgn"); })();

    const firebaseConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUserEmail = "";
    let currentUserName = "User";

    auth.onAuthStateChanged(user => {
        if (!user) window.location.href = "1.html";
        else {
            currentUserEmail = user.email.toLowerCase();
            db.collection('users').doc(user.uid).get().then(doc => {
                if(doc.exists) currentUserName = doc.data().firstName + " " + doc.data().lastName;
            });
        }
    });

    async function sendEmail(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-submit');
        const status = document.getElementById('status-msg');
        
        // Convert to lowercase for consistent DB matching
        const to = document.getElementById('to_email').value.trim().toLowerCase();
        const subject = document.getElementById('subject').value;
        const message = document.getElementById('message').value;

        btn.disabled = true;
        btn.innerText = "Processing...";
        status.innerText = "Checking recipient...";

        try {
            // 1. Check if the 'To' email exists in OUR internal Firebase database
            const userQuery = await db.collection('users').where('email', '==', to).get();
            let isInternal = !userQuery.empty;

            if (!isInternal) {
                // 2. EXTERNAL: Send via EmailJS
                console.log("Sending external email via EmailJS...");
                
                const templateParams = {
                    to_email: to,              // Maps to 'To Email' in settings
                    from_name: currentUserName,// Maps to 'From Name'
                    reply_to: currentUserEmail,// Maps to 'Reply To' in settings (Sender's email)
                    subject: subject,          // Maps to {{subject}} in template
                    message: message           // Maps to {{message}} in template
                };

                await emailjs.send('service_5hs4mqf', 'template_rm8jf2c', templateParams);
                status.innerText = "Sent via EmailJS (Real Email). Saving...";
            } else {
                // 3. INTERNAL: Skip EmailJS, just save to DB
                console.log("Internal user found. Skipping EmailJS.");
                status.innerText = "Internal User found. Sending locally...";
            }

            // 4. Record the email in Firestore (for Sent Items & Inbox)
            await db.collection('emails').add({
                to: to,
                from: currentUserEmail,
                fromName: currentUserName,
                subject: subject,
                message: message,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                type: isInternal ? 'internal' : 'external'
            });

            status.innerText = "Sent Successfully!";
            status.style.color = "green";
            
            setTimeout(() => {
                window.location.href = "2.html";
            }, 1500);

        } catch (error) {
            console.error(error);
            status.innerText = "Error: " + error.message;
            status.style.color = "red";
            btn.disabled = false;
            btn.innerText = "Send";
        }
    }
</script>
</body>
</html>
