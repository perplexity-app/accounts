<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compose - Email App</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #fff; margin: 0; }
        .header { background: #f6f8fc; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; }
        .back-btn { display: flex; align-items: center; cursor: pointer; color: #5f6368; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        .form-group { margin-bottom: 15px; position: relative;}
        input, textarea {
            width: 100%; padding: 10px; border: none; border-bottom: 1px solid #e0e0e0;
            font-family: inherit; font-size: 15px; outline: none; box-sizing: border-box;
        }
        input:focus, textarea:focus { border-bottom: 2px solid #1a73e8; }
        textarea { height: 300px; resize: none; margin-top: 10px; }
        
        .send-btn {
            background-color: #1a73e8; color: white; border: none; padding: 10px 24px;
            border-radius: 4px; font-weight: bold; cursor: pointer; float: left;
            display: flex; align-items: center;
        }
        .send-btn:hover { background-color: #1557b0; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .send-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .status { margin-left: 15px; display: inline-block; padding-top: 10px; color: #5f6368; }
    </style>
</head>
<body>

<div class="header">
    <div class="back-btn" onclick="window.location.href='2.html'">
        <span class="material-icons">arrow_back</span> Back to Inbox
    </div>
    <div style="font-weight: bold; color: #444;">New Message</div>
</div>

<div class="container">
    <form id="email-form" onsubmit="sendEmail(event)">
        <div class="form-group">
            <input type="email" id="to_email" placeholder="To" required>
        </div>
        <div class="form-group">
            <input type="text" id="subject" placeholder="Subject" required>
        </div>
        <div class="form-group">
            <textarea id="message" placeholder="Type your message here..." required></textarea>
        </div>
        
        <button type="submit" id="btn-submit" class="send-btn">Send</button>
        <span id="status-msg" class="status"></span>
    </form>
</div>

<script>
    // 1. Initialize EmailJS
    (function(){
        emailjs.init("Yr9MutUoHOEONnFgn"); // Public Key
    })();

    // 2. Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let userData = null;

    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.href = "1.html";
        } else {
            currentUser = user;
            // Fetch user details for "From Name"
            db.collection('users').doc(user.uid).get().then(doc => {
                if(doc.exists) userData = doc.data();
            });
        }
    });

    async function sendEmail(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-submit');
        const status = document.getElementById('status-msg');
        const to = document.getElementById('to_email').value.trim();
        const subject = document.getElementById('subject').value;
        const message = document.getElementById('message').value;

        btn.disabled = true;
        btn.innerText = "Sending...";
        status.innerText = "";

        const fromName = userData ? `${userData.firstName} ${userData.lastName}` : "User";

        try {
            // STEP 1: Check if recipient exists in our Firebase 'users' collection
            const userQuery = await db.collection('users').where('email', '==', to).get();
            
            let isInternal = !userQuery.empty;
            let method = "";

            if (isInternal) {
                // --- SCENARIO A: Internal User (Fake Send) ---
                console.log("User found in database. Sending internally.");
                method = "Internal Database";
                // We do NOT call EmailJS here.
            } else {
                // --- SCENARIO B: External User (Real EmailJS Send) ---
                console.log("User not found in DB. Sending via EmailJS.");
                method = "EmailJS";
                
                const templateParams = {
                    to_email: to, // Note: EmailJS template usually auto-sends to the account owner or needs logic. 
                                  // Since you want to send TO the input email, ensure your EmailJS Service is allowed to send to arbitrary emails 
                                  // or (more likely on free tier) it sends to YOU telling you who the message is for.
                                  // Standard "Contact Form" logic sends email TO YOU. 
                                  // To send TO THE USER, you need to map the "To" field in EmailJS dashboard.
                    from_name: fromName,
                    reply_to: currentUser.email,
                    subject: subject,
                    message: message
                };

                await emailjs.send('service_5hs4mqf', 'template_rm8jf2c', templateParams);
            }

            // STEP 2: Store record in Firestore (Needed for 'Sent' folder and 'Inbox' if internal)
            await db.collection('emails').add({
                to: to,
                from: currentUser.email,
                fromName: fromName,
                subject: subject,
                message: message,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                type: isInternal ? 'internal' : 'external'
            });

            status.innerText = `Sent successfully via ${method}!`;
            status.style.color = "green";
            
            // Reset form after 2 seconds
            setTimeout(() => {
                window.location.href = "2.html";
            }, 2000);

        } catch (error) {
            console.error(error);
            status.innerText = "Error sending email: " + error.message;
            status.style.color = "red";
            btn.disabled = false;
            btn.innerText = "Send";
        }
    }
</script>
</body>
</html>
