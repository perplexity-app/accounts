<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox - Email App</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f6f8fc; overflow: hidden; }
        
        /* Layout */
        .app-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 250px; background: white; padding: 15px; display: flex; flex-direction: column; border-right: 1px solid #e0e0e0; }
        .logo { font-size: 22px; color: #444; display: flex; align-items: center; margin-bottom: 20px; padding-left: 10px; }
        .logo span { color: #ea4335; margin-left: 5px; }
        
        .compose-btn {
            background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); border-radius: 24px;
            padding: 15px 25px; display: flex; align-items: center; cursor: pointer;
            width: fit-content; margin-bottom: 20px; color: #3c4043; font-weight: 500;
            transition: box-shadow 0.2s;
        }
        .compose-btn:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .compose-btn .material-icons { margin-right: 10px; color: #ea4335; }
        
        .nav-item {
            padding: 10px 10px 10px 20px; border-radius: 0 20px 20px 0; cursor: pointer;
            color: #202124; display: flex; align-items: center; margin-bottom: 2px;
        }
        .nav-item:hover { background: #f1f3f4; }
        .nav-item.active { background: #e8f0fe; color: #1967d2; font-weight: bold; }
        .nav-item .material-icons { margin-right: 15px; font-size: 20px; }
        
        .user-profile { margin-top: auto; padding: 10px; display: flex; align-items: center; border-top: 1px solid #eee; }
        .user-profile img { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; object-fit: cover;}
        .logout-btn { color: #5f6368; cursor: pointer; font-size: 12px; margin-left: auto; }

        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; background: white; border-radius: 8px; margin: 10px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .toolbar { padding: 10px 20px; border-bottom: 1px solid #f1f3f4; display: flex; align-items: center; }
        .email-list { flex: 1; overflow-y: auto; }
        
        /* Email Row */
        .email-row {
            display: grid; grid-template-columns: 200px 1fr 100px; padding: 12px 20px;
            border-bottom: 1px solid #f1f3f4; cursor: pointer; align-items: center;
        }
        .email-row:hover { box-shadow: inset 1px 0 0 #dadce0, inset -1px 0 0 #dadce0, 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15); z-index: 1; position: relative; }
        .sender { font-weight: bold; color: #202124; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .content { color: #5f6368; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .subject { color: #202124; }
        .date { font-size: 12px; color: #5f6368; text-align: right; }
        
        .empty-state { text-align: center; margin-top: 50px; color: #ccc; }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo"><span class="material-icons">mail</span> <span>Mbox</span></div>
        
        <div class="compose-btn" onclick="window.location.href='3.html'">
            <span class="material-icons">add</span> Compose
        </div>
        
        <div class="nav-item active" id="btn-inbox" onclick="loadView('inbox')">
            <span class="material-icons">inbox</span> Inbox
        </div>
        <div class="nav-item" id="btn-sent" onclick="loadView('sent')">
            <span class="material-icons">send</span> Sent
        </div>

        <div class="user-profile">
            <img id="profile-pic" src="" alt="User">
            <div style="display:flex; flex-direction: column;">
                <span id="user-name" style="font-size:14px;">User</span>
                <span class="logout-btn" onclick="logout()">Sign out</span>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div class="main">
        <div class="toolbar">
            <h3 id="page-title" style="margin: 0; font-weight: normal; color: #5f6368;">Inbox</h3>
        </div>
        <div class="email-list" id="email-list">
            <!-- Emails go here -->
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let currentUserEmail = "";

    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.href = "1.html";
        } else {
            currentUserEmail = user.email;
            loadProfile(user.uid);
            loadView('inbox'); // Default view
        }
    });

    function loadProfile(uid) {
        db.collection('users').doc(uid).get().then(doc => {
            if(doc.exists) {
                document.getElementById('profile-pic').src = doc.data().photoURL;
                document.getElementById('user-name').innerText = doc.data().firstName;
            }
        });
    }

    let unsubscribe = null;

    function loadView(view) {
        // UI Updates
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`btn-${view}`).classList.add('active');
        document.getElementById('page-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);
        
        const listContainer = document.getElementById('email-list');
        listContainer.innerHTML = '<div style="padding:20px;">Loading...</div>';

        // Detach previous listener if exists
        if (unsubscribe) unsubscribe();

        let query;
        if(view === 'inbox') {
            // Get emails where I am the recipient
            query = db.collection('emails')
                      .where('to', '==', currentUserEmail)
                      .orderBy('timestamp', 'desc');
        } else {
            // Get emails where I am the sender
            query = db.collection('emails')
                      .where('from', '==', currentUserEmail)
                      .orderBy('timestamp', 'desc');
        }

        unsubscribe = query.onSnapshot(snapshot => {
            listContainer.innerHTML = "";
            if (snapshot.empty) {
                listContainer.innerHTML = '<div class="empty-state">No emails found</div>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : '';
                
                // For Sent view, show 'To: [Recipient]', for Inbox show 'From: [Sender]'
                const displayUser = view === 'inbox' ? data.fromName || data.from : `To: ${data.to}`;
                
                const html = `
                    <div class="email-row">
                        <div class="sender">${displayUser}</div>
                        <div class="content"><span class="subject">${data.subject}</span> - ${data.message}</div>
                        <div class="date">${date}</div>
                    </div>
                `;
                listContainer.innerHTML += html;
            });
        });
    }

    function logout() {
        auth.signOut().then(() => window.location.href = "1.html");
    }
</script>
</body>
</html>
