<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reset Password</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { background: black; color: white; padding: 15px; width: 100%; border-radius: 99px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <h1>Reset Password</h1>
    
    <div id="step1">
        <p>Enter the code from your logged-in device (6.html)</p>
        <input type="text" id="code" placeholder="Enter Code">
        <button class="btn" onclick="verifyCode()">Verify</button>
    </div>

    <div id="step2" class="hidden">
        <p>Enter New Password</p>
        <input type="password" id="newPass">
        <button class="btn" onclick="updatePass()">Change Password</button>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw", authDomain: "xperts-metadata.firebaseapp.com", projectId: "xperts-metadata", storageBucket: "xperts-metadata.firebasestorage.app", messagingSenderId: "514845910910", appId: "1:514845910910:web:5a2402130a97b5d749b52f", measurementId: "G-CQ5KWGJSZB" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    let userId = null;

    if(!email) { alert("No email provided"); window.location.href="1.html"; }

    async function verifyCode() {
        const code = document.getElementById('code').value;
        
        try {
            const snap = await db.collection('users').where('email', '==', email).get();
            if(snap.empty) { alert("User not found"); return; }
            
            const doc = snap.docs[0];
            const data = doc.data();
            
            // Check Code and Time (Valid for 5 mins = 300000ms)
            const now = Date.now();
            if (data.authCode === code && (now - data.authCodeTime < 300000)) {
                userId = doc.id;
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
            } else {
                alert("Invalid or Expired Code");
            }
        } catch(e) { console.error(e); }
    }

    async function updatePass() {
        const p = document.getElementById('newPass').value;
        if(!p) return;
        await db.collection('users').doc(userId).update({ password: p });
        alert("Password Updated");
        window.location.href = "1.html?email="+email;
    }
</script>
</body>
</html>