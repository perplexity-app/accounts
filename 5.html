<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enter Code</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; justify-content: center; height: 100vh; align-items: center; margin: 0; }
        .container { width: 400px; padding: 20px; }
        .logo { font-size: 30px; margin-bottom: 20px; }
        .input-box { width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; letter-spacing: 5px; font-size: 20px; text-align: center; }
        .btn { width: 100%; padding: 15px; background: #000; color: #fff; border-radius: 25px; border: none; cursor: pointer; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <i class="fa-brands fa-x-twitter logo"></i>
        <h1>We sent you a code</h1>
        <p>Check your other logged-in devices to get the confirmation code.</p>
        <p style="font-size: 13px; color: #666">Check 6.html?email=... to see the code</p>
        
        <input type="text" id="otp-input" class="input-box" placeholder="XXXXXX" maxlength="6">
        <button class="btn" onclick="verifyCode()">Next</button>
        <p id="msg" style="color:red; text-align:center; display:none"></p>
    </div>

<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-firestore.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw", authDomain: "xperts-metadata.firebaseapp.com", projectId: "xperts-metadata", storageBucket: "xperts-metadata.firebasestorage.app", messagingSenderId: "514845910910", appId: "1:514845910910:web:5a2402130a97b5d749b52f", measurementId: "G-CQ5KWGJSZB" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');

    async function verifyCode() {
        const entered = document.getElementById('otp-input').value;
        const msg = document.getElementById('msg');
        
        if(!email) { msg.innerText = "No email provided"; msg.style.display = 'block'; return; }

        const snap = await db.collection('users').where('email', '==', email).get();
        if(snap.empty) { msg.innerText = "User not found"; msg.style.display = 'block'; return; }

        const data = snap.docs[0].data();
        const now = Date.now();
        
        // Validate OTP and Time (5 mins = 300000 ms)
        if (data.otp === entered && (now - data.otpTimestamp) < 300000) {
            // Success - Redirect to login or auto-login
            // For this flow, we go back to login with pre-filled email
            alert("Verified! You can now login (In real app, reset password here).");
            window.location.href = `1.html?email=${email}`;
        } else {
            msg.innerText = "Invalid or expired code"; 
            msg.style.display = 'block';
        }
    }
</script>
</body>
</html>