<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Security Code</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #000; color: white; margin: 0; }
        .code { font-size: 40px; font-weight: bold; letter-spacing: 5px; margin: 20px 0; }
        .timer { color: #888; }
        button { padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <h2>Security Code</h2>
    <p>Use this code to verify your identity on other devices.</p>
    
    <div class="code" id="displayCode">Loading...</div>
    <div class="timer">Refreshes in <span id="timeLeft">300</span>s</div>
    <br>
    <button onclick="generateCode()">Refresh Code</button>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw", authDomain: "xperts-metadata.firebaseapp.com", projectId: "xperts-metadata", storageBucket: "xperts-metadata.firebasestorage.app", messagingSenderId: "514845910910", appId: "1:514845910910:web:5a2402130a97b5d749b52f", measurementId: "G-CQ5KWGJSZB" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // In a real app, we get the UID from the Auth State or LocalStorage
    // For this demo, we assume the user is "Logged In" via LocalStorage and we grab the first session
    const sessions = JSON.parse(localStorage.getItem('x_sessions') || '[]');
    if(sessions.length === 0) {
        document.body.innerHTML = "<h1>Please Login First in 1.html</h1>";
    } else {
        const currentUser = sessions[0]; // Using primary session
        
        generateCode(currentUser.uid);
        
        // Timer countdown logic
        setInterval(() => {
            let t = parseInt(document.getElementById('timeLeft').innerText);
            if(t > 0) document.getElementById('timeLeft').innerText = t - 1;
        }, 1000);
    }

    async function generateCode(uid) {
        if(!uid) uid = sessions[0].uid;
        
        // Generate 6 digit code
        const code = Math.floor(100000 + Math.random() * 900000).toString();
        
        document.getElementById('displayCode').innerText = code;
        document.getElementById('timeLeft').innerText = "300";

        // Save to Firestore
        await db.collection('users').doc(uid).update({
            authCode: code,
            authCodeTime: Date.now()
        });
    }
</script>
</body>
</html>