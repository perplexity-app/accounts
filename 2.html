<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign up for X</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #999; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .modal { background: #fff; width: 100%; max-width: 600px; min-height: 500px; border-radius: 16px; padding: 20px; box-sizing: border-box; position: relative; display: flex; flex-direction: column; }
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .close-btn { font-size: 20px; cursor: pointer; margin-right: 20px; }
        .logo { flex-grow: 1; text-align: center; font-size: 24px; margin-right: 40px; } 
        h2 { margin: 20px 0; font-size: 24px; }
        .step { display: none; flex-direction: column; flex-grow: 1; }
        .step.active { display: flex; }
        .input-wrapper { margin-bottom: 20px; }
        input, select { width: 100%; padding: 15px; border: 1px solid #cfd9de; border-radius: 4px; font-size: 16px; box-sizing: border-box; margin-top: 5px; }
        .dob-group { display: flex; gap: 10px; }
        .btn { background: #000; color: #fff; border: none; padding: 15px; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: auto; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 4px; display: none; }
        .email-suffix { position: absolute; right: 15px; top: 22px; color: #536471; background: #fff; padding-left: 5px; }
        .relative { position: relative; }
    </style>
</head>
<body>

<div class="toast" id="toast"></div>

<div class="modal">
    <div class="header">
        <i class="fa-solid fa-xmark close-btn" onclick="history.back()"></i>
        <div class="logo"><i class="fa-brands fa-x-twitter"></i></div>
    </div>
    
    <!-- Step 1: Name -->
    <div class="step active" id="step1">
        <h2>Create your account</h2>
        <div class="input-wrapper">
            <input type="text" id="fname" placeholder="First Name">
        </div>
        <div class="input-wrapper">
            <input type="text" id="lname" placeholder="Last Name">
        </div>
        <button class="btn" onclick="nextStep(1)">Next</button>
    </div>

    <!-- Step 2: DOB & Gender -->
    <div class="step" id="step2">
        <h2>Basic Info</h2>
        <div class="input-wrapper">
            <label>Date of birth</label>
            <div class="dob-group">
                <select id="dob-month" style="flex:2"></select>
                <select id="dob-day" style="flex:1"></select>
                <select id="dob-year" style="flex:1"></select>
            </div>
        </div>
        <div class="input-wrapper">
            <label>Gender</label>
            <select id="gender">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Rather not to say">Rather not to say</option>
            </select>
        </div>
        <button class="btn" onclick="nextStep(2)">Next</button>
    </div>

    <!-- Step 3: Mobile -->
    <div class="step" id="step3">
        <h2>Add your phone</h2>
        <div class="input-wrapper">
            <input type="tel" id="mobile" placeholder="Mobile Number">
        </div>
        <button class="btn" onclick="nextStep(3)">Next</button>
    </div>

    <!-- Step 4: Email -->
    <div class="step" id="step4">
        <h2>Create your email</h2>
        <div class="input-wrapper relative">
            <input type="text" id="email-handle" placeholder="username">
            <span class="email-suffix">@pplx.com</span>
        </div>
        <p style="font-size: 12px; color: #536471">Only alphabets, numbers, +, -, _ allowed. No capitals.</p>
        <button class="btn" onclick="nextStep(4)">Next</button>
    </div>

    <!-- Step 5: Password -->
    <div class="step" id="step5">
        <h2>You'll need a password</h2>
        <div class="input-wrapper">
            <input type="password" id="password" placeholder="Password">
        </div>
        <button class="btn" onclick="finishSignup()">Sign up</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-firestore.js"></script>
<script>
    const firebaseConfig = { apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw", authDomain: "xperts-metadata.firebaseapp.com", projectId: "xperts-metadata", storageBucket: "xperts-metadata.firebasestorage.app", messagingSenderId: "514845910910", appId: "1:514845910910:web:5a2402130a97b5d749b52f", measurementId: "G-CQ5KWGJSZB" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Populate DOB
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const mSelect = document.getElementById('dob-month');
    months.forEach((m, i) => mSelect.innerHTML += `<option value="${i+1}">${m}</option>`);
    
    const dSelect = document.getElementById('dob-day');
    for(let i=1; i<=31; i++) dSelect.innerHTML += `<option value="${i}">${i}</option>`;

    const ySelect = document.getElementById('dob-year');
    const currentYear = new Date().getFullYear();
    for(let i=currentYear; i>=1900; i--) ySelect.innerHTML += `<option value="${i}">${i}</option>`;

    let userData = {};

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    async function nextStep(current) {
        if(current === 1) {
            const f = document.getElementById('fname').value.trim();
            const l = document.getElementById('lname').value.trim();
            if(!f || !l) return showToast("Name is required");
            userData.firstName = f; userData.lastName = l;
            changeStep(2);
        } else if (current === 2) {
            userData.dob = `${document.getElementById('dob-day').value}/${document.getElementById('dob-month').value}/${document.getElementById('dob-year').value}`;
            userData.gender = document.getElementById('gender').value;
            changeStep(3);
        } else if (current === 3) {
            const mob = document.getElementById('mobile').value.trim();
            if(!mob) return showToast("Mobile is required");
            // Check unique mobile
            const snap = await db.collection('users').where('mobile', '==', mob).get();
            if(!snap.empty) return showToast("Mobile number already in use");
            userData.mobile = mob;
            changeStep(4);
        } else if (current === 4) {
            let handle = document.getElementById('email-handle').value.trim();
            if(/[A-Z]/.test(handle)) return showToast("Capital letters not allowed");
            if(!/^[a-z0-9+_-]+$/.test(handle)) return showToast("Invalid characters");
            
            const email = handle + "@pplx.com";
            // Check unique email
            const snap = await db.collection('users').where('email', '==', email).get();
            if(!snap.empty) return showToast("Email handle taken");
            
            userData.email = email;
            changeStep(5);
        }
    }

    function changeStep(n) {
        document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
        document.getElementById(`step${n}`).classList.add('active');
    }

    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    async function finishSignup() {
        const pass = document.getElementById('password').value;
        if(!pass) return showToast("Password required");
        userData.password = pass;
        userData.profileColor = getRandomColor();

        try {
            await db.collection('users').add(userData);
            
            // Auto Login
            const session = {
                email: userData.email,
                name: userData.firstName + ' ' + userData.lastName,
                dpColor: userData.profileColor,
                loginTime: new Date().toISOString()
            };
            
            let list = JSON.parse(localStorage.getItem('x_users_list') || '[]');
            list.push(session);
            localStorage.setItem('x_users_list', JSON.stringify(list));
            localStorage.setItem('x_current_user', JSON.stringify(session));

            window.location.href = "https://abc.xyz";
        } catch (e) {
            showToast("Error creating account: " + e.message);
        }
    }
</script>
</body>
</html>