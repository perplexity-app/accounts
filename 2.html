<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign up for X</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; justify-content: center; height: 100vh; margin:0; }
        .container { width: 100%; max-width: 600px; padding: 20px; display: flex; flex-direction: column; }
        .logo { align-self: center; margin-bottom: 20px; }
        h2 { font-size: 24px; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        input, select { width: 100%; padding: 15px; border: 1px solid #cfd9de; border-radius: 4px; font-size: 16px; margin-top: 5px; box-sizing: border-box; }
        .btn-next { background: #000; color: #fff; border-radius: 30px; padding: 15px; font-weight: bold; border: none; cursor: pointer; width: 100%; margin-top: auto; }
        .step { display: none; flex-direction: column; height: 100%; }
        .step.active { display: flex; }
        .dob-container { display: flex; gap: 10px; }
        .error { color: red; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="logo">
        <svg viewBox="0 0 24 24" aria-hidden="true" width="30" height="30"><g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></g></svg>
    </div>

    <!-- Step 1: Name -->
    <div id="step1" class="step active">
        <h2>Create your account</h2>
        <div class="input-group">
            <input type="text" id="firstName" placeholder="First Name">
        </div>
        <div class="input-group">
            <input type="text" id="lastName" placeholder="Last Name">
        </div>
        <button class="btn-next" onclick="nextStep(1)">Next</button>
    </div>

    <!-- Step 2: DOB & Gender -->
    <div id="step2" class="step">
        <h2>Basic Info</h2>
        <p>Date of birth</p>
        <div class="dob-container">
            <select id="month" style="flex:2;"></select>
            <select id="day" style="flex:1;"></select>
            <select id="year" style="flex:1;"></select>
        </div>
        <div class="input-group" style="margin-top:20px;">
            <label>Gender</label>
            <select id="gender">
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Rather not to say">Rather not to say</option>
            </select>
        </div>
        <button class="btn-next" onclick="nextStep(2)">Next</button>
    </div>

    <!-- Step 3: Mobile -->
    <div id="step3" class="step">
        <h2>Add your phone</h2>
        <div class="input-group">
            <input type="tel" id="mobile" placeholder="Mobile Number">
        </div>
        <button class="btn-next" onclick="nextStep(3)">Next</button>
    </div>

    <!-- Step 4: Email -->
    <div id="step4" class="step">
        <h2>Create your email</h2>
        <div class="input-group">
            <input type="text" id="emailPrefix" placeholder="username" onkeyup="validateEmailInput(this)">
            <span style="position: absolute; right: 40px; margin-top: -35px; color: #536471;">@pplx.com</span>
            <div id="emailError" class="error"></div>
        </div>
        <p style="font-size:13px; color:gray;">Only alphabets, numbers, +, -, _ allowed. No caps.</p>
        <button class="btn-next" onclick="nextStep(4)">Next</button>
    </div>

    <!-- Step 5: Password -->
    <div id="step5" class="step">
        <h2>You'll need a password</h2>
        <div class="input-group">
            <input type="password" id="password" placeholder="Password (8+ chars)">
        </div>
        <button class="btn-next" onclick="finishSignup()">Sign up</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Populate DOB
    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const mSelect = document.getElementById('month');
    months.forEach((m, i) => mSelect.innerHTML += `<option value="${i+1}">${m}</option>`);
    
    const dSelect = document.getElementById('day');
    for(let i=1; i<=31; i++) dSelect.innerHTML += `<option value="${i}">${i}</option>`;

    const ySelect = document.getElementById('year');
    const currentYear = new Date().getFullYear();
    for(let i=currentYear; i>=1900; i--) ySelect.innerHTML += `<option value="${i}">${i}</option>`;

    let userData = {};

    function nextStep(current) {
        if(current === 1) {
            if(!document.getElementById('firstName').value || !document.getElementById('lastName').value) return alert("Name required");
            userData.firstName = document.getElementById('firstName').value;
            userData.lastName = document.getElementById('lastName').value;
        }
        if(current === 2) {
            userData.dob = `${document.getElementById('year').value}-${document.getElementById('month').value}-${document.getElementById('day').value}`;
            userData.gender = document.getElementById('gender').value;
        }
        if(current === 3) {
            if(!document.getElementById('mobile').value) return alert("Mobile required");
            userData.mobile = document.getElementById('mobile').value;
        }
        if(current === 4) {
            const prefix = document.getElementById('emailPrefix').value;
            if(!prefix || document.getElementById('emailError').innerText !== "") return alert("Invalid Email");
            userData.email = prefix + "@pplx.com";
        }

        document.getElementById(`step${current}`).classList.remove('active');
        document.getElementById(`step${current+1}`).classList.add('active');
    }

    function validateEmailInput(input) {
        const val = input.value;
        // Regex: Lowercase a-z, 0-9, +, -, _
        const regex = /^[a-z0-9\+\-\_]+$/;
        
        if (/[A-Z]/.test(val)) {
            input.value = val.toLowerCase();
        }
        
        if (!regex.test(input.value) && input.value.length > 0) {
            document.getElementById('emailError').innerText = "Invalid characters allowed.";
        } else {
            document.getElementById('emailError').innerText = "";
        }
    }

    async function finishSignup() {
        const password = document.getElementById('password').value;
        if(password.length < 8) return alert("Password must be 8+ chars");
        userData.password = password;

        // Random Color for DP
        const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);
        userData.dpColor = randomColor;

        try {
            // Check if email exists
            const doc = await db.collection('users').doc(userData.email).get();
            if(doc.exists) return alert("Email already exists");

            await db.collection('users').doc(userData.email).set(userData);
            
            // Login Success
            let sessions = JSON.parse(localStorage.getItem('x_users_sessions') || '[]');
            sessions.push({ email: userData.email, data: userData });
            localStorage.setItem('x_users_sessions', JSON.stringify(sessions));

            window.location.href = "1.html";
        } catch(e) {
            console.error(e);
            alert("Error creating account");
        }
    }
</script>
</body>
</html>
