<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: Roboto, Arial, sans-serif; margin: 0; background: #f6f8fc; height: 100vh; display: flex; flex-direction: column; }
        header { background: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .logo { font-size: 20px; color: #ea4335; font-weight: bold; display: flex; align-items: center; }
        
        #app-content { flex: 1; overflow-y: auto; padding: 10px; position: relative; }
        
        /* Email Item */
        .email-item { background: white; padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; cursor: pointer; border-radius: 5px; margin-bottom: 5px; }
        .avatar { width: 35px; height: 35px; background: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; color: #555; }
        .info { flex: 1; }
        .sender { font-weight: bold; color: #222; }
        .sub { font-size: 14px; color: #555; }

        /* Compose FAB */
        .fab { position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; background: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 30px; color: #ea4335; cursor: pointer; z-index: 99; }
        
        /* Compose Box */
        .compose-box { background: white; height: 100%; padding: 20px; display: flex; flex-direction: column; }
        .input-f { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 20px; font-weight: bold; align-self: flex-start; cursor: pointer; }

        /* Error/Loading State */
        .status-msg { text-align: center; margin-top: 50px; color: #666; }
        .error-msg { color: red; background: #ffe6e6; padding: 10px; border-radius: 5px; margin: 10px; text-align: center; border: 1px solid red; }

        /* Context Menu */
        #ctx-menu { display: none; position: fixed; background: white; border: 1px solid #ccc; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); z-index: 1000; width: 150px; }
        .ctx-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .ctx-item:hover { background: #f0f0f0; }
        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; z-index: 999; }
    </style>
</head>
<body>

<header>
    <div class="logo"><i class="material-icons">mail</i> &nbsp;Mail</div>
    <div style="font-size: 12px;">
        <span id="u-email">...</span> 
        <a href="#" onclick="logout()" style="color: #1a73e8; margin-left: 10px;">Logout</a>
    </div>
</header>

<div id="error-banner" class="error-msg" style="display:none;"></div>

<div id="app-content">
    <div class="status-msg">Initializing App...</div>
</div>

<div id="fab" class="fab" onclick="window.location.search='?v=compose'">+</div>

<!-- Context Menu -->
<div id="overlay" onclick="closeMenu()"></div>
<div id="ctx-menu">
    <div class="ctx-item" onclick="doDelete()">Delete</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let selectedId = null;

    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.href = "login.html";
        } else {
            currentUser = user;
            document.getElementById('u-email').innerText = user.email;
            checkUrl();
        }
    });

    function logout() { auth.signOut(); }

    function checkUrl() {
        const p = new URLSearchParams(window.location.search);
        const v = p.get('v');
        const content = document.getElementById('app-content');
        const fab = document.getElementById('fab');

        content.innerHTML = ""; 

        if (v === 'compose') {
            fab.style.display = 'none';
            renderCompose(content);
        } else if (v === 'read') {
            fab.style.display = 'none';
            renderRead(content, p.get('id'));
        } else {
            fab.style.display = 'flex';
            renderInbox(content);
        }
    }

    // --- INBOX ---
    function renderInbox(div) {
        div.innerHTML = '<div class="status-msg">Loading Inbox...</div>';

        // NOTE: I removed .orderBy('timestamp') because it causes freezing if Index is missing
        db.collection('emails')
          .where('to', '==', currentUser.email)
          .onSnapshot(
            (snap) => {
                div.innerHTML = ''; // Clear loading
                if (snap.empty) {
                    div.innerHTML = '<div class="status-msg">No emails found.</div>';
                    return;
                }
                snap.forEach(doc => {
                    const d = doc.data();
                    const el = document.createElement('div');
                    el.className = 'email-item';
                    
                    // Simple right click/long press handler
                    el.oncontextmenu = (e) => { e.preventDefault(); openMenu(e, doc.id); };

                    el.onclick = () => { window.location.search = `?v=read&id=${doc.id}`; };
                    
                    el.innerHTML = `
                        <div class="avatar">${d.from[0].toUpperCase()}</div>
                        <div class="info">
                            <div class="sender">${d.from}</div>
                            <div class="sub">${d.subject}</div>
                        </div>
                    `;
                    div.appendChild(el);
                });
            },
            (error) => {
                // THIS catches the specific "Missing permissions" or "Index" errors
                console.error(error);
                document.getElementById('error-banner').style.display = 'block';
                document.getElementById('error-banner').innerText = "Database Error: " + error.message;
                div.innerHTML = '<div class="status-msg" style="color:red">Failed to load.</div>';
            }
          );
    }

    // --- COMPOSE ---
    function renderCompose(div) {
        div.innerHTML = `
            <div class="compose-box">
                <h3>New Message</h3>
                <input id="to" class="input-f" type="email" placeholder="To (email)">
                <input id="sub" class="input-f" type="text" placeholder="Subject">
                <textarea id="body" class="input-f" style="flex:1" placeholder="Message"></textarea>
                <div>
                    <button class="btn" onclick="send()">Send</button>
                    <button class="btn" style="background:#ccc; color:black" onclick="window.history.back()">Cancel</button>
                </div>
            </div>
        `;
    }

    function send() {
        const to = document.getElementById('to').value.toLowerCase().trim();
        const sub = document.getElementById('sub').value;
        const body = document.getElementById('body').value;

        if(!to || !sub) return alert("Missing To or Subject");

        db.collection('emails').add({
            from: currentUser.email,
            to: to,
            subject: sub,
            body: body,
            timestamp: Date.now() // Using simple number to avoid timestamp issues
        }).then(() => {
            alert("Sent!");
            window.location.search = "?v=inbox";
        }).catch(e => alert("Send failed: " + e.message));
    }

    // --- READ ---
    function renderRead(div, id) {
        div.innerHTML = '<div class="status-msg">Loading...</div>';
        db.collection('emails').doc(id).get().then(doc => {
            if(!doc.exists) {
                div.innerHTML = "Email not found.";
                return;
            }
            const d = doc.data();
            div.innerHTML = `
                <div style="background:white; min-height:100%; padding:20px;">
                    <button onclick="window.history.back()" style="margin-bottom:10px;">&larr; Back</button>
                    <h2>${d.subject}</h2>
                    <p style="color:#666">From: ${d.from}</p>
                    <hr>
                    <p style="white-space: pre-wrap;">${d.body}</p>
                </div>
            `;
        }).catch(e => div.innerHTML = "Error: " + e.message);
    }

    // --- MENU ---
    function openMenu(e, id) {
        selectedId = id;
        const m = document.getElementById('ctx-menu');
        m.style.display = 'block';
        m.style.left = e.pageX + 'px';
        m.style.top = e.pageY + 'px';
        document.getElementById('overlay').style.display = 'block';
    }

    function closeMenu() {
        document.getElementById('ctx-menu').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function doDelete() {
        if(selectedId) {
            db.collection('emails').doc(selectedId).delete();
            closeMenu();
        }
    }
</script>
</body>
</html>
```[[1](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQEJQ__vZl7XnxoZ78qSxKSiBz5j_namnQjvXwYX90116p2bPLLNyfCr5Rw-Sv06Aus3YeX97f4_wjUM2JzaOFQVtL6ZUZ4WVJc8vXq-BZ0vrLAf7LrBPf8roeJuSXlMowIFEKyhAOWrsFFdvyo2SjUrH-S-n1F47KrBOmVbqV0cA3s88Okmai0I97BNG2IJ4VSd_EtffLrPDy2AKQ%3D%3D)][[2](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQHldrGPzd9dPPclFM8tpC9d_D6MXZy4bJ_3-uFzO2hXd0QERkiplELHLIdAiL1xPq_9GQuq9WYy5k1cMIqYDZPrtDO_C1oCGvFDT8EPAExxo7F4O7ztOC_KqYHeKHuyIM_xa3clbHLWCarD7PaDn7VQzRiq8Ui7pJ1SW0CTYMAm4BGrZmfzDjgTnh1fGaNPQEurdxBIGySC2XZHRmDQhWg%3D)][[3](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQFZO5UAIhY17USHXiQCMXrtYCqBH_t46jl-DiEI44DHKutR6cAUoM_qfnpQvJ2ODiw0EJWo3KVOjNyDKNPQRmkxC6DcJMV82zZSeDCEFyihzSb7v4sEtTV8M25y9Eq2QnKQu-LhNeasiY-XMmTMw2stRDhEkrQxD_jJVsMZ-mF_XaaKSw4Cv9QybBmgLH9Ah-bTIQ4GKciIByzfmkJ_Q5WneQ%3D%3D)][[4](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQFN6f7Vzk-X3cNtaax2ov57nU0HVMSpK3HRnjkM0yRNiEpD4zB9LOuYTUjAftErbTWYBeDzcjHSEW8YYJRjUV-poJk8Csi2k_AKUS3DCodAt1rEA0YKRQZexrAU31j_YqswhCHklNJmesl0x_6P90UOAHvSsrI_r-xSXhng3jJBRee4MHg8FfFGHQusPRj82p12ZALITpzLQ6g%3D)][[5](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQGi4IIJ14C-py50pCmY6N7jK0xeoMCe-dRHlnZA28musfHH-HkfUM-OFgzz0LCtx33mao2RUP6-Bp6rl1CIUP7KmTvEBQc1B3-IRMlTSy176EqFcJEOR4hPcsoV6KwYgkXj0y8MojzFvdoDqhYb6U_Tob2VUTgA3jS2M38XwCaAW5_N4sk-UtVKB6AR5CAH83havSe5_p6SoBKsOZO-49yqk0lg)][[6](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQH4bfVzDKoexBDf6ejWsmjakhLmSCfQRLnZv82-_3hluLMKN46jFxLrkHd7p2XYN233sfHMDI9Uo6RicNWjhDToDvTv9LPQ5JUtCzmWAmWI1vrbLJ-oZROim_7Y11WfBvuLj_ZTHMfPD0tt3cmvKcsEz3tLYm7MQQfSUooCxcyPtQKyjWTA8V86xqomwK6A6MuPY3oK6ds_VnAXomGZf4RXu-r3KqZBgQK0duZ559DXZoqxRAZl)][[7](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQFn8ZNJCxF34ozc39YWSbYOMLcsamWfCfPgRtU3byjtHOpJV-aXfndCCJkvmE994LXX0ytrrILumuGRKc7zmWoyJgAy01SuxIag0i9eQX1RnqDQCipxy-AO4xeXEIV5eiElQtCguDVQu91NvOHIgIdLHJMubipme0RcYmHz2jFMfpFd9VRqeGp-LbmDR4HXz085Sm7g02tLkpDqP8daaCEDIJuqoiAOtqvRVLA5ydlveQgCyWN28g%3D%3D)][[8](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQGnwx_Kvj2DVWXCjYCxcZDlyScJ-dVLlWHf84fM_9oO_oKe2IzbqG9G6SzclPDmWf9K0lHg6L44RfAkjogxsj1rYno1879A8uMl6Ii8-WVo-MQ3KxRzHSRvRmfI_oenxuiUTdbTUhdk__7tH2o3vXoaKZR_AehFSViawmUCaWB3-dnl79uKZjgQ1iP-5zqYm6bCkB02VC_NWAvLGqowg8FYIC1zAdNh5VdWDhQkC3N4EZz7L77lu-09)][[9](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQH90w49JBDtxeKn3NLOz3jrRyGk8uhQ-pFMYcis2YhZ_WJNbmlAdnbjLQ3F1iplDef2UrJtt4HQT-HY23Kj3USCCxoe3uOEaAFT3zi5MHHG1rRb_EliJtfTiJUiuCp3UGfqXD1VMU-h7IIMATg4jbFlVJdKNsu7iMShpPU0UwBD9H6p-wYtohYpTcBt03R9NlpDGCZ-v0I1gkrllMhzyYoncAj1MMQFi58%3D)][[10](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQHUkBDIyHrfTsjOS8mKzL-_oL2UlGTdrI-E9ILb1NZQQMkrBpvHGQlNca3EUYoTT-0dlH2KvQNVuejptVhTtpiO57UmxOMWBItV7brX5xvAjCD9IInBsSQ8n8EdFFeUjIgau5Lu2i1xNZaSpfRxwYYv8gMK903fPeFHDJTWPMeKLz6-A6yT_oS1kADS-Nge797J-A-YYK73EKcu72msEkz4Fv4bh3jY2wV83iK04mL-RQoiqGo%3D)][[11](https://www.google.com/url?sa=E&q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQEGc73SWYUuwQX0pd2TKgomg7tUPtZbQ0B6xLHL1fpLMTK6576kFuZTyQh8h342Sg6ZgOc1hBFX-_s8uA-8ZXiEvRN3yXERU9PS03WHN0wqUi2e95dW1UHYl_cwAYv0nfMXmE5u7qSp2GfWtX3P-uVwUmg_E7ABM-qJIbsrA6kIZuGI4vA6fr6nsa2eA25eYUsj-u5sDxd3BnQITxxrOIuWL4GmlLCVF82BEiysgnCMi-WWe9gtuA%3D%3D)]