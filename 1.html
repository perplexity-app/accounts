<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log in to X</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #fff; color: #0f1419; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 400px; padding: 20px; box-sizing: border-box; }
        .header { display: flex; justify-content: center; margin-bottom: 30px; }
        .logo { font-size: 30px; color: #0f1419; }
        h1 { font-size: 31px; font-weight: 700; margin-bottom: 30px; color: #0f1419; }
        .input-group { margin-bottom: 20px; position: relative; }
        .input-group label { display: block; font-size: 13px; color: #536471; margin-bottom: 4px; }
        .input-box { width: 100%; padding: 16px 12px; font-size: 17px; border: 1px solid #cfd9de; border-radius: 4px; outline: none; box-sizing: border-box; transition: border-color 0.2s; }
        .input-box:focus { border-color: #1d9bf0; }
        .btn { width: 100%; background-color: #0f1419; color: #fff; border: none; padding: 15px; border-radius: 25px; font-size: 15px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn:disabled { opacity: 0.5; cursor: default; }
        .btn-outline { background-color: transparent; color: #0f1419; border: 1px solid #cfd9de; margin-top: 10px; }
        .action-link { margin-top: 20px; font-size: 14px; color: #1d9bf0; cursor: pointer; text-decoration: none; display: inline-block; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1d9bf0; color: white; padding: 12px 24px; border-radius: 4px; display: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .hidden { display: none; }
        .pass-toggle { position: absolute; right: 15px; top: 38px; cursor: pointer; color: #536471; }
    </style>
</head>
<body>

<div class="toast" id="toast"></div>

<div class="container">
    <div class="header"><i class="fa-brands fa-x-twitter logo"></i></div>
    <h1 id="page-title">Sign in to X</h1>

    <!-- Step 1: Identify -->
    <div id="step-identify">
        <div class="input-group">
            <input type="text" id="identifier" class="input-box" placeholder="Phone, email, or username">
        </div>
        <button class="btn" onclick="handleNext()">Next</button>
        <button class="btn btn-outline" onclick="window.location.href='4.html'">Forgot email?</button>
        <div style="text-align: center; margin-top: 20px;">
            <p style="font-size: 14px; color: #536471;">Don't have an account? <a href="2.html" style="color: #1d9bf0; text-decoration: none;">Sign up</a></p>
        </div>
    </div>

    <!-- Step 2: Confirm Email (If logged in via Mobile) -->
    <div id="step-confirm-email" class="hidden">
        <p style="color: #536471; margin-bottom: 20px;">Please verify your email address to continue.</p>
        <div class="input-group">
            <input type="email" id="confirm-email-input" class="input-box" placeholder="Enter your email address">
        </div>
        <button class="btn" onclick="verifyLinkedEmail()">Next</button>
        <a href="#" class="action-link" onclick="goToForgotEmail()">Forgot email?</a>
    </div>

    <!-- Step 3: Password -->
    <div id="step-password" class="hidden">
        <div class="input-group">
            <input type="text" id="read-only-email" class="input-box" style="background:#f7f9f9; color:#536471" disabled>
        </div>
        <div class="input-group">
            <input type="password" id="password" class="input-box" placeholder="Password">
            <i class="fa-regular fa-eye-slash pass-toggle" onclick="togglePass()"></i>
        </div>
        <button class="btn" onclick="handleLogin()">Log in</button>
        <a href="#" class="action-link" onclick="goToForgotPassword()">Forgot password?</a>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-firestore.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const emailParam = urlParams.get('email');
    const typeParam = urlParams.get('type');
    
    // Check local session
    const currentUser = localStorage.getItem('x_current_user');
    if (currentUser && typeParam !== 'another-login') {
        // If already logged in and not asking to add account
        window.location.href = "https://abc.xyz";
    }

    let globalUserData = null;

    // Initialization
    if (emailParam) {
        // Case 4: URL has email
        document.getElementById('step-identify').classList.add('hidden');
        document.getElementById('step-password').classList.remove('hidden');
        document.getElementById('read-only-email').value = emailParam;
        
        // Fetch user data in background to ensure it exists
        db.collection('users').where('email', '==', emailParam).get().then(snap => {
            if(!snap.empty) globalUserData = snap.docs[0].data();
        });
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    async function handleNext() {
        const input = document.getElementById('identifier').value.trim();
        if(!input) return showToast("Please enter phone, email or username");

        // Check if input is email or phone
        const isEmail = input.includes('@');
        
        if (isEmail) {
            // Case: Login via Email
            const snap = await db.collection('users').where('email', '==', input).get();
            if (snap.empty) return showToast("Could not find your account");
            
            // Check if this email is already logged in on this device
            const loggedInUsers = JSON.parse(localStorage.getItem('x_users_list') || '[]');
            if(loggedInUsers.some(u => u.email === input)) {
                return showToast("Email Already Logged in This Device");
            }

            globalUserData = snap.docs[0].data();
            document.getElementById('step-identify').classList.add('hidden');
            document.getElementById('step-password').classList.remove('hidden');
            document.getElementById('read-only-email').value = input;
        } else {
            // Case 1: Login via Mobile
            const snap = await db.collection('users').where('mobile', '==', input).get();
            if (snap.empty) return showToast("Could not find account with this number");
            
            globalUserData = snap.docs[0].data();
            // Prompt says: "If Mobile Number is Correct then ask For email id"
            document.getElementById('step-identify').classList.add('hidden');
            document.getElementById('step-confirm-email').classList.remove('hidden');
        }
    }

    function verifyLinkedEmail() {
        const enteredEmail = document.getElementById('confirm-email-input').value.trim();
        if (enteredEmail === globalUserData.email) {
            document.getElementById('step-confirm-email').classList.add('hidden');
            document.getElementById('step-password').classList.remove('hidden');
            document.getElementById('read-only-email').value = enteredEmail;
        } else {
            showToast("Incorrect email address.");
        }
    }

    async function handleLogin() {
        const pass = document.getElementById('password').value;
        const email = document.getElementById('read-only-email').value;

        if (!globalUserData) {
            // Re-fetch if needed
            const snap = await db.collection('users').where('email', '==', email).get();
            if(!snap.empty) globalUserData = snap.docs[0].data();
        }

        if (globalUserData && globalUserData.password === pass) {
            // Success
            const session = {
                email: globalUserData.email,
                name: globalUserData.firstName + ' ' + globalUserData.lastName,
                dpColor: globalUserData.profileColor || '#000',
                loginTime: new Date().toISOString()
            };

            // Add to multi-login list
            let list = JSON.parse(localStorage.getItem('x_users_list') || '[]');
            // remove duplicates
            list = list.filter(u => u.email !== session.email);
            list.push(session);
            localStorage.setItem('x_users_list', JSON.stringify(list));
            
            // Set active user
            localStorage.setItem('x_current_user', JSON.stringify(session));

            // Redirect
            window.location.href = "https://abc.xyz";
        } else {
            showToast("Wrong password");
        }
    }

    function togglePass() {
        const p = document.getElementById('password');
        const i = document.querySelector('.pass-toggle');
        if (p.type === 'password') {
            p.type = 'text';
            i.classList.remove('fa-eye-slash');
            i.classList.add('fa-eye');
        } else {
            p.type = 'password';
            i.classList.add('fa-eye-slash');
            i.classList.remove('fa-eye');
        }
    }

    function goToForgotEmail() {
        // Redirect to 4.html
        window.location.href = "4.html";
    }

    function goToForgotPassword() {
        const email = document.getElementById('read-only-email').value;
        // Redirect to 5.html with param
        window.location.href = `5.html?email=${email}`;
    }
</script>
</body>
</html>